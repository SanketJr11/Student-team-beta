version: '3.8'

services:
  # ====================================
  # Discovery Server (Eureka)
  # ====================================
  discovery-server:
    build:
      context: ../../services/discovery-server
      dockerfile: Dockerfile
    container_name: discovery-server
    ports:
      - "8761:8761"
    environment:
      - SPRING_APPLICATION_NAME=eureka-server
      - SERVER_PORT=8761
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health/liveness"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    networks:
      - microservices-network
    labels:
      - "com.example.description=Eureka Discovery Server"

  # ====================================
  # Config Server
  # ====================================
  config-server:
    build:
      context: ../../services/config-server
      dockerfile: Dockerfile
    container_name: config-server
    ports:
      - "8888:8888"
    environment:
      - SPRING_APPLICATION_NAME=config-server
      - SERVER_PORT=8888
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
    depends_on:
      - discovery-server
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/actuator/health/liveness"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    networks:
      - microservices-network
    labels:
      - "com.example.description=Spring Cloud Config Server"

  # ====================================
  # API Gateway
  # ====================================
  api-gateway:
    build:
      context: ../../services/api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      - SPRING_APPLICATION_NAME=api-gateway
      - SERVER_PORT=8080
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - SPRING_PROFILE=dev
    depends_on:
      - discovery-server
      - config-server
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health/liveness"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    networks:
      - microservices-network
    labels:
      - "com.example.description=Spring Cloud API Gateway"

networks:
  microservices-network:
    driver: bridge
    name: student-booking-network
